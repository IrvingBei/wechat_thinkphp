$(function(){"use strict";var t=$('input[name="is_long"]'),e=$("#time-range");t.on("click",function(){1==$(this).val()?e.hide():e.show()});var n=$("#open-coupon-window"),u=$("#coupon-selected"),a=$("#coupon-window"),c=$("#search-coupon"),o=$("#find-coupon"),r=$("#coupon-list"),s=$("#coupon-empty");n.on("click",function(){a.modal("show")});var i=0;function d(t){$.ajax({type:"POST",data:"keyword="+t,url:"/Ajax/get_coupons",dataType:"JSON",beforeSend:function(){r.empty().parents("table").hide(),s.hide(),o.prop("disabled",!0)},success:function(t){var e=t.status,n=t.data;if(40001==e)window.location.reload();else if(0==e)s.show();else if(1==e)toastr.error("查询结果过多，请完善查询内容"),c.focus();else{r.parents("table").show();for(var a=0,o=n.length;a<o;a++)r.append(f(a,n[a].coupon_id,n[a].type,n[a].discount,n[a].total,n[a].reduce))}},error:function(){toastr.error("服务异常，请联系管理人员")},complete:function(){o.prop("disabled",!1)}})}a.on("show.bs.modal",function(){0===i&&(d(""),i++)}),o.on("click",function(){var t=$.trim(c.val());if(!t.length)return c.focus(),!1;d(t)});var l=function(t){switch(parseInt(t)){case 1:return"折扣券";case 2:return"满减券";default:return"无门槛券"}},p=function(t,e,n,a){switch(parseInt(t)){case 1:return 100*e+" 折";case 2:return"满"+n+"元减"+a+"元";default:return a+"元无门槛券"}},f=function(t,e,n,a,o,c){return'<tr><td class="text-center">'+(t+=1)+"</td><td>"+l(n)+"</td><td>"+p(n,a,o,c)+'</td><td class="text-center"><button data-id="'+e+'" data-type="'+n+'" data-discount="'+a+'" data-total="'+o+'" data-reduce="'+c+'" class="btn btn-xs btn-danger">选择</button></td></tr>'};r.on("click","button",function(){var t,e,n,a,o,c=$(this).data("id"),r=$(this).data("type"),s=$(this).data("discount"),i=$(this).data("total"),d=$(this).data("reduce");0<$(".coupon-"+c).size()?toastr.warning("活动中已包含此优惠券"):u.append((n=s,a=i,o=d,'<tr class="coupon-'+(t=c)+'"><td class="text-center">'+l(e=r)+"</td><td>"+p(e,n,a,o)+'</td><td class="text-center"><input type="text" name="max[]" class="form-control text-center" value="0" required /> </td> <td class="text-center"><input type="text" name="limit[]" class="form-control text-center" value="0" required /></td><th class="text-center col-sm-1"><input type="hidden" name="coupon_id[]" value="'+t+'"><a href="javascript:;" class="coupon-delete">删除</a></th></tr>'))}),u.on("click",".coupon-delete",function(){$(this).parents("tr").remove()});var h=$('input[name="range"]'),m=$("#used-range"),v=$("#used-range-selector");h.on("click",function(){1==$(this).val()?m.hide():m.show()}),v.multi({enable_search:!0,search_placeholder:"可输入 商品名称、SKU属性 检索"})});
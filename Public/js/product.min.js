function initFindSku(t){var o,e=$("#SKU-CHOOSE-BTN"),n=$("#SKU-CHOOSE-WINDOW"),r=n.find('select[name="sku_category"]'),a=n.find('input[name="sku_keyword"]'),i=$("#SKU-FIND-BTN"),s=$("#SKU-LIST"),c=$("#EMPTY"),u=0;switch(t){case"PRODUCT":o="添加";break;default:$(".wrapper").html("<h1>模块 "+t+" 初始化失败，请刷新重试</h1>")}function l(t,e){$.ajax({type:"POST",data:"cat_id="+t+"&keyword="+e,url:"/Ajax/get_skus",dataType:"JSON",beforeSend:function(){s.parents("table").hide(),c.hide(),s.empty(),i.prop("disabled",!0)},success:function(t){var e=t.status,n=t.data;if(1==e){s.parents("table").show();for(var a=0,i=n.length;a<i;a++)s.append(d(a,n[a].sku_id,n[a].sku_code,n[a].sku_name,n[a].sku_price))}else c.show()},error:function(){toastr.error("服务异常，请联系管理人员")},complete:function(){i.prop("disabled",!1)}})}e.on("click",function(){n.modal("show")}),n.on("show.bs.modal",function(){a.empty(),$.ajax({type:"POST",url:"/Ajax/get_category",dataType:"JSON",beforeSend:function(){r.prop("disabled",!0).empty().append('<option value="">正在加载</option>')},success:function(t){var e="";if(t.data){e+='<option value="">所有分类</option>';for(var n=0,a=t.data.length;n<a;n++)if(null!=t.data[n].child){e+='<optgroup label="'+t.data[n].cate_name+'">';for(var i=0,o=t.data[n].child.length;i<o;i++)e+='<option value="'+t.data[n].child[i].cat_id+'">'+t.data[n].child[i].cat_name+"</option>";e+="</optgroup>"}}else e+='<option value="">暂无分类</option>';r.empty().append(e)},error:function(){toastr.error("服务异常，请联系管理人员")},complete:function(){r.prop("disabled",!1)}}),0===u&&(l($.trim(r.val()),$.trim(a.val())),u++)}),i.on("click",function(){if(!$.trim(r.val()).length&&!$.trim(a.val()).length)return a.focus(),!1;l($.trim(r.val()),$.trim(a.val()))}),a.on("keypress",function(t){13==t.keyCode&&$.trim(a.val()).length&&l($.trim(r.val()),$.trim(a.val()))});var d=function(t,e,n,a,i){return'<tr><td class="text-center">'+(t+=1)+"</td><td>"+n+"</td><td>"+a+'</td><td class="text-center">'+i+'</td><td class="text-center"><button type="button" class="btn btn-xs btn-danger" data-sku-id="'+e+'" data-sku-name="'+a+'" data-sku-price="'+i+'" data-sku-code="'+n+'">'+o+"</button></td></tr>"},p={};return p.LIST=s,p.WINDOW=n,p}$(function(t){"use strict";var m=$("#PL"),e=initFindSku("PRODUCT"),n=e.LIST;e.WINDOW;n.on("click","button",function(){var t=$(this).attr("data-sku-id"),e=$(this).attr("data-sku-code"),n=$(this).attr("data-sku-name"),a=$(this).attr("data-sku-price");0<$(".-sku-"+t).size()?toastr.warning("此商品已选入商品套餐，无需再次选择"):(m.append(i(t,e,n,a)),m.parents("table").show(),o())});var i=function(t,e,n,a){return'<tr class="-sku-'+t+'"><td>'+e+"</td><td>"+n+'</td><td class="text-center">'+a+'<input type="hidden" name="sku_price[]" value="'+a+'" /></td><td class="text-center"><input type="text" class="form-control input-sm text-center isNumber" name="count[]" value="1" /></td><td class="text-center"><div class="input-group"><input type="text" class="form-control input-sm text-center isMoney" name="shop_price[]" value="0.00" /><span class="input-group-addon gray-bg">元</span></div></td><td class="text-center"><div class="input-group"><input type="text" class="form-control input-sm text-center isMoney" name="point_cny[]" value="0.00" /><span class="input-group-addon gray-bg b-lr-none">元</span><input type="text" class="form-control input-sm text-center isNumber" name="point_cnt[]" value="0" /><span class="input-group-addon gray-bg"">积分</span></div></td><td class="text-center"><input type="hidden" name="sku_id[]" value="'+t+'"><button type="button" class="btn btn-sm btn-warning">删除</button></td></tr>'};m.on("click","button",function(){$(this).parents("tr").remove(),0==a()&&m.parents("table").hide()}),m.on("keyup",".isNumber, .isMoney",function(){(isNaN($.trim($(this).val()))||parseFloat($.trim($(this).val()))<0)&&$(this).val(0),o()}).on("focus",".isNumber, .isMoney",function(){$(this).select()}).on("blur",".isNumber, .isMoney",function(){0==$.trim($(this).val()).length&&$(this).val(0);var t=$(this).is(".isNumber")?toDecimal($.trim($(this).val())):parseFloat($.trim($(this).val())).toFixed(2);$(this).val(t),o()});var o=function(){for(var t=0,e=0,n=0,a=0,i=0,o=m.children("tr"),r=0,s=o.size();r<s;r++){var c=$.trim(o.eq(r).find('[name*="sku_price"]').val())||0,u=$.trim(o.eq(r).find('[name*="count"]').val())||0,l=$.trim(o.eq(r).find('[name*="shop_price"]').val())||0,d=$.trim(o.eq(r).find('[name*="point_cny"]').val())||0,p=$.trim(o.eq(r).find('[name*="point_cnt"]').val())||0;t+=toDecimal(c*u),e+=toDecimal(u),n+=toDecimal(l*u),a+=toDecimal(d*u),i+=toDecimal(p*u)}$("#TSP").text(toDecimal(t).toFixed(2)),$("#TSN").text(toDecimal(e)),$("#TPP").text(toDecimal(n).toFixed(2)),$("#TPC").text(toDecimal(a).toFixed(2)),$("#TPN").text(toDecimal(i))},a=function(){return m.find("tr").size()};$("form").on("submit",function(){if(0==a())return toastr.error("至少选择一款单品，才能创建商品套餐"),!1}),o()}(window));
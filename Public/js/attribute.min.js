function ids_sort(t,r){if(t.length){var a=-1<t.indexOf("_")?t.split("_"):[t];return a.push(r),a.sort().join("_")}return""+r}function group_in_array(t,a){return t.findIndex(function(t,r){return t.group_name==a})}function attr_in_array(t,a){return t.findIndex(function(t,r){return t.attr_name==a})}function exec_recursion(t){var r=t.length;if(2<=r){for(var a=t[0].length,n=t[1].length,e=new Array(a*n),o=0,u=0;u<a;u++)for(var i=0;i<n;i++)t[0][u]instanceof Array?e[o]=t[0][u].concat(t[1][i]):e[o]=[t[0][u]].concat(t[1][i]),o++;var p=new Array(r-1);for(u=2;u<r;u++)p[u-1]=t[u];return p[0]=e,exec_recursion(p)}return t[0]}$(function(t){"use strict";var h=[],m=$("#attribute_table"),f=m.find("thead"),v=m.find("tbody"),r=$('input[name="attr_id[]"]:checked');0<r.size()&&$.each(r,function(){var t=$(this),r={group_id:t.data("group-id"),group_name:t.data("group-name"),group_attr:[]},a={attr_id:t.data("attr-id"),attr_name:t.data("attr-name")};-1==group_in_array(h,r.group_name)&&h.push(r);var n=group_in_array(h,r.group_name);-1==attr_in_array(h[n].group_attr,a.attr_name)&&h[n].group_attr.push(a)}),$(document).on("click",".check-attr",function(){var t=$(this),r=t.prop("checked"),a={group_id:t.data("group-id"),group_name:t.data("group-name"),group_attr:[]},n={attr_id:t.data("attr-id"),attr_name:t.data("attr-name")};if(r){-1==group_in_array(h,a.group_name)&&h.push(a);var e=group_in_array(h,a.group_name);-1==attr_in_array(h[e].group_attr,n.attr_name)&&h[e].group_attr.push(n)}else{e=group_in_array(h,a.group_name);var o=attr_in_array(h[e].group_attr,n.attr_name);-1<o&&(h[e].group_attr.splice(o,1),h[e].group_attr.length||h.splice(e,1))}for(var u=[],i=[],p=0,_=h.length;p<_;p++){var c=h[p];u.push([c.group_id,c.group_name]),i.push([]);for(var s=0,d=c.group_attr.length;s<d;s++){var g=[],l={attr_id:c.group_attr[s].attr_id,attr_name:c.group_attr[s].attr_name,group_id:c.group_id};g.push(l),i[p].push(g)}}u.length&&i.length?(function(t){var r="<tr>";t.sort(function(t,r){return t[0]-r[0]});for(var a=0,n=t.length;a<n;a++)r+="<th>"+t[a][1]+"</th>";r+='<th class="col-sm-2 text-center">成本价</th>',r+='<th class="col-sm-2 text-center">销售价</th>',r+='<th class="col-sm-1 text-center">操作</th>',r+="</tr>",f.empty().append(r)}(u),function(t){for(var r="",a=0,n=t.length;a<n;a++){var e="";r+="<tr>",t[a].sort(function(t,r){return t.group_id-r.group_id});for(var o=0,u=t[a].length;o<u;o++)r+="<td>"+t[a][o].attr_name,r+="</td>",e=ids_sort(e,t[a][o].attr_id);r+='<td><input name="costs[]" type="text" class="form-control text-center" value="0" /></td>',r+='<td><input name="prices[]" type="text" class="form-control text-center" value="0" /></td>',r+='<td class="text-center"><a class="delete" href="javascript:;">删除</a>',r+='<input type="hidden" class="sku-'+e+'" name="attr_ids[]" value="'+e+'" />',r+="</td>",r+="</tr>"}v.empty().append(r)}(exec_recursion(i)),function(){var t=$('input[name="items_json"]').val();if(t.length)try{t=JSON.parse(t);for(var r=0,a=t.length;r<a;r++){var n=m.find(".sku-"+t[r].attr_ids).parents("tr");n.find('input[name="costs[]"]').val(t[r].base_price),n.find('input[name="prices[]"]').val(t[r].shop_price)}}catch(t){console.log(t.message)}}()):(f.empty(),v.empty())}),v.on("click","a.delete",function(){confirm("是否确认删除此属性商品？")&&$(this).parents("tr").remove()})});